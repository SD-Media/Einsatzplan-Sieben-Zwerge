<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Arbeitseinsätze</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif; margin: 0; padding: 0; background: #f0f4f8; color: #333 }
    .container { max-width: 1200px; margin: 20px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1) }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap }
    .nav-tab { background: #ddd; padding: 10px 20px; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; border: none }
    .nav-tab.active { background: #fff; border-bottom: 2px solid #fff }
    .tab-content { display: none }
    .tab-content.active { display: block }

    .kategorien { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px }
    .kategorie { padding: 6px 12px; border-radius: 20px; color: white; font-weight: 600 }
    .gruen { background: #4caf50 } .orange { background: #ff9800 } .lila { background: #9c27b0 } .blau { background: #2196f3 } .grau { background: #607d8b }

    .uebersicht { width: 100%; border-collapse: collapse; margin-bottom: 20px }
    .uebersicht th, .uebersicht td { border: 1px solid #ccc; padding: 8px; text-align: center }
    .uebersicht th { background: #2196f3; color: white }
    .diff-positive { color: #2e7d32; font-weight: 700 }
    .diff-negative { color: #c62828; font-weight: 700 }

    input, select, button { font-size: 1rem }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box }
    button.btn-primary { background: #2196f3; color: white; padding: 10px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; width: auto }
    button.btn-danger  { background: #f44336; color: white; padding: 10px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; width: auto }
    button:hover { opacity: .92 }

    .einsatz-box { border-left: 10px solid #ccc; background: #f9f9f9; padding: 15px; margin-bottom: 15px; border-radius: 10px }
    .einsatz-gartenarbeit { border-left-color: #4caf50 }
    .einsatz-verkaufsaktion { border-left-color: #ff9800 }
    .einsatz-feste { border-left-color: #9c27b0 }
    .einsatz-kindergartenpflege { border-left-color: #2196f3 }
    .einsatz-sonstiges { border-left-color: #607d8b }

    /* kompakte Zeile */
    .einsatz-info { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 10px; line-height: 1.4 }
    .einsatz-info > div { white-space: nowrap }

    .helfer-input { display: inline-block; margin: 5px; padding: 6px 10px; border: 2px solid #f44336; border-radius: 6px; min-width: 150px; font-size: 1rem; width: auto; background: #fff }
    .helfer-input.filled { background: #e0f7fa; border-color: #4caf50 }
    .helfer-input:disabled { background: #f0f0f0; color: #666 }
    .helfer-section { margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px }
    .helfer-section h4 { margin: 0 0 8px 0; color: #555; font-size: 1rem }

    .name-input-section { max-width: 520px; margin-bottom: 20px }
    #nameInput { max-width: 340px }

    .status-info { font-size: .92em; color: #666; margin-top: 8px }

    /* Admin Login Row */
    .admin-login-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap }
    #adminPasswort { width: 160px; padding: 8px }
    .toggle-wrap { display: flex; align-items: center; gap: 6px; white-space: nowrap; user-select: none }

    .admin-edit-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px }
    .admin-actions { display: flex; gap: 8px; flex-wrap: wrap }

    /* Modal (für Bearbeiten und Info) */
    .modal { display: none; position: fixed; z-index: 9999; inset: 0; background: rgba(0,0,0,.5); align-items: center; justify-content: center; padding: 20px }
    .modal-content { background: #fff; border-radius: 12px; max-width: 760px; width: 100%; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,.2) }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px }
    .modal-title { font-size: 1.1rem; font-weight: 800 }
    .modal-close { background: transparent; border: none; font-size: 1.6rem; cursor: pointer; width: auto }
    .modal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px }

    /* kleine Hilfeknöpfe oben */
    .top-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 12px }
  </style>
</head>
<body>
  <div class="container">
    <h1>Arbeitseinsätze Waldorfkindergarten Sieben Zwerge</h1>
    
    <div class="tabs">
      <button class="nav-tab active" onclick="showTab('einsatzTab', event)">Einsätze</button>
      <button class="nav-tab" onclick="showTab('meineTab', event)">Meine Einsätze</button>
      <button class="nav-tab" onclick="showTab('adminTab', event)">Admin</button>
    </div>

    <!-- Einsätze -->
    <div id="einsatzTab" class="tab-content active">
      <div class="top-actions">
        <button class="btn-primary" onclick="openInfoModal()">ℹ️ Info</button>
        <button class="btn-primary" onclick="druckeInfo()">Anleitung drucken</button>
      </div>

      <div class="kategorien">
        <span class="kategorie gruen">Gartenarbeit</span>
        <span class="kategorie orange">Verkaufsaktion</span>
        <span class="kategorie lila">Feste</span>
        <span class="kategorie blau">Kindergartenpflege</span>
        <span class="kategorie grau">Sonstiges</span>
      </div>

      <h2>Elternübersicht</h2>
      <table class="uebersicht">
        <thead>
          <tr><th>Name</th><th>IST-Punkte</th><th>SOLL-Punkte</th><th>Differenz</th></tr>
        </thead>
        <tbody id="parentOverview"></tbody>
      </table>

      <h2>Alle verfügbaren Einsätze</h2>
      <div id="einsatzListe"></div>
    </div>

    <!-- Meine Einsätze -->
    <div id="meineTab" class="tab-content">
      <h2>Meine Einsätze anzeigen</h2>
      <div class="name-input-section">
        <input id="nameInput" placeholder="Gib deinen Namen ein">
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn-primary" onclick="zeigeEigeneEinsaetze()">Anzeigen</button>
          <button class="btn-primary" onclick="druckeEigeneEinsaetze()">Diese Ansicht drucken</button>
        </div>
      </div>
      <div id="eigeneEinsaetze"></div>
    </div>

    <!-- Adminbereich -->
    <div id="adminTab" class="tab-content">
      <h2>Admin-Anmeldung</h2>
      <div class="admin-login-row">
        <input id="adminPasswort" type="password" placeholder="Admin Passwort">
        <label class="toggle-wrap"><input id="showPass" type="checkbox" onclick="togglePass()"> Passwort anzeigen</label>
        <button class="btn-primary" onclick="loginAdmin()">Anmelden</button>
      </div>
      
      <div id="adminArea" style="display:none">
        <h2>Neuen Einsatz erstellen</h2>
        <div class="admin-edit-grid" style="margin-bottom:10px">
          <input id="einsatzTitel" placeholder="Einsatzname">
          <input id="einsatzDatum" placeholder="Datum (TT.MM.JJJJ)">
          <input id="einsatzUhrzeit" placeholder="Uhrzeit">
          <input id="einsatzVerantwortlich" placeholder="Verantwortlicher">
          <select id="einsatzKategorie">
            <option value="Gartenarbeit">Gartenarbeit</option>
            <option value="Verkaufsaktion">Verkaufsaktion</option>
            <option value="Feste">Feste</option>
            <option value="Kindergartenpflege">Kindergartenpflege</option>
            <option value="Sonstiges">Sonstiges</option>
          </select>
          <input id="einsatzStunden" placeholder="Punkte" type="number">
          <input id="einsatzHelferanzahl" placeholder="Helferanzahl" type="number">
        </div>
        <button class="btn-primary" onclick="addEinsatz()">Einsatz erstellen</button>
        
        <h3>Vorhandene Einsätze</h3>
        <div id="adminEinsaetze"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Einsatz bearbeiten -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Einsatz bearbeiten</div>
        <button class="modal-close" onclick="closeEditModal()">×</button>
      </div>
      <div class="modal-grid">
        <input id="edit-name" placeholder="Einsatzname">
        <input id="edit-datum" placeholder="Datum (TT.MM.JJJJ)">
        <input id="edit-uhrzeit" placeholder="Uhrzeit">
        <input id="edit-verantwortlich" placeholder="Verantwortlicher">
        <select id="edit-kategorie">
          <option value="Gartenarbeit">Gartenarbeit</option>
          <option value="Verkaufsaktion">Verkaufsaktion</option>
          <option value="Feste">Feste</option>
          <option value="Kindergartenpflege">Kindergartenpflege</option>
          <option value="Sonstiges">Sonstiges</option>
        </select>
        <input id="edit-punkte" type="number" placeholder="Punkte">
        <input id="edit-anzahl" type="number" placeholder="Helferanzahl">
      </div>
      <div class="modal-actions">
        <button class="btn-primary" onclick="saveEdit()">Speichern</button>
        <button class="btn-danger" onclick="closeEditModal()">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Info/Hilfe -->
  <div id="infoModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Hinweise zum Bereich „Einsätze“</div>
        <button class="modal-close" onclick="closeInfoModal()">×</button>
      </div>
      <div id="infoContent">
        <p><strong>Wichtiger Hinweis:</strong> Das Laden und Speichern kann ein paar Sekunden dauern da die Daten direkt in eine Excel-Tabelle übertragen werden. Nach kurzer Zeit sind deine Änderungen gespeichert und auch in der Elternübersicht sichtbar.</p>
        <ul>
          <li>Hier findest du alle anstehenden Arbeitseinsätze mit Datum Uhrzeit Verantwortlichen und der Anzahl der benötigten Helfer</li>
          <li>Trage dich als Helfer ein indem du in ein freies Feld klickst und deinen Namen einträgst</li>
          <li>Die Anzeige „x / y Helfer“ zeigt wie viele Plätze schon belegt sind und wie viele noch frei sind</li>
          <li>Türkis markierte Felder sind bereits ausgefüllt leere Felder sind frei</li>
          <li>Achte auf die korrekte Schreibweise deines Namens damit deine Punkte in der Elternübersicht richtig zugeordnet werden</li>
          <li><strong>Unter dem Reiter „Meine Einsätze“ oben in der Mitte kannst du</strong> gezielt deine eigenen Termine anzeigen und ausdrucken</li>
        </ul>
      </div>
      <div class="modal-actions">
        <button class="btn-primary" onclick="druckeInfo()">Anleitung drucken</button>
        <button class="btn-danger" onclick="closeInfoModal()">Schließen</button>
      </div>
    </div>
  </div>

  <script>
    // === Konfiguration ===
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ1P23tsbN5zX-BmqG8eNCg0GhxcTdBhxrogBAZYjheiTZGXPuvOo3PhVEx8SVjCAhqQ/exec';
    const ADMIN_PASS = 'SiebenZwerge';
    const AUTO_REFRESH_MS = 15000;

    // === State ===
    let globaleDaten = [];
    let globaleSollPunkte = 10;
    let isBusyNetwork = false;
    let editContext = { id: null };

    // === Tabs ===
    function showTab(id, event) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
    }

    // === Admin Login ===
    function togglePass() {
      const inp = document.getElementById('adminPasswort');
      inp.type = (inp.type === 'password') ? 'text' : 'password';
      inp.focus();
    }
    document.addEventListener('keydown', (e) => {
      if (document.activeElement?.id === 'adminPasswort' && e.key === 'Enter') {
        e.preventDefault();
        loginAdmin();
      }
    });
    function loginAdmin() {
      const passwortInput = document.getElementById('adminPasswort');
      if (passwortInput.value !== ADMIN_PASS) {
        alert('Falsches Passwort');
        return;
      }
      document.getElementById('adminArea').style.display = 'block';
      ladeEinsaetze();
      alert('Erfolgreich als Admin angemeldet!');
    }

    // === Daten laden mit Datumssortierung ===
    function ladeEinsaetze() {
      return fetch(SCRIPT_URL)
        .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`); return r.json(); })
        .then(json => {
          const arr = (json.data || []).slice();
          arr.sort((a, b) => parseDE(a.datum) - parseDE(b.datum));
          globaleDaten = arr;
          globaleSollPunkte = json.sollPunkte || 10;

          zeigeElternUebersicht();
          zeigeEigeneEinsaetze();
          zeigeEinsaetzeFuerEltern();
          zeigeAdminEinsaetze();
        })
        .catch(err => {
          console.error('Ladefehler:', err);
        });
    }

    // Auto-Refresh alle 15 s, aber nur wenn kein Eingabefeld aktiv ist und keine Modals offen sind und kein Netz-POST läuft
    function canAutoRefresh() {
      if (isBusyNetwork) return false;
      const active = document.activeElement;
      const isEditingField = active && (active.matches('input, textarea, select') || active.isContentEditable);
      const editOpen = document.getElementById('editModal').style.display === 'flex';
      const infoOpen = document.getElementById('infoModal').style.display === 'flex';
      return !isEditingField && !editOpen && !infoOpen;
    }
    function startAutoRefresh() {
      setInterval(() => {
        if (canAutoRefresh()) ladeEinsaetze();
      }, AUTO_REFRESH_MS);
    }
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && canAutoRefresh()) ladeEinsaetze();
    });

    // === Helpers ===
    function parseDE(s) {
      if (!s || typeof s !== 'string') return new Date(9999, 11, 31);
      const m = s.trim().match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
      if (!m) return new Date(9999, 11, 31);
      const [_, dd, mm, yyyy] = m;
      return new Date(Number(yyyy), Number(mm) - 1, Number(dd));
    }
    function katClassName(k) {
      if (!k) return 'einsatz-sonstiges';
      const s = k.toString().trim().toLowerCase();
      if (s.startsWith('garten')) return 'einsatz-gartenarbeit';
      if (s.startsWith('verkaufs')) return 'einsatz-verkaufsaktion';
      if (s.startsWith('fest')) return 'einsatz-feste';
      if (s.includes('kindergarten')) return 'einsatz-kindergartenpflege';
      return 'einsatz-sonstiges';
    }

    // === Elternübersicht ===
    function zeigeElternUebersicht() {
      const eltern = {};
      globaleDaten.forEach(einsatz => {
        Object.keys(einsatz).forEach(key => {
          if (key.startsWith('Helfer') && einsatz[key]) {
            const name = einsatz[key].trim();
            if (name) eltern[name] = (eltern[name] || 0) + Number(einsatz.Punkte || 0);
          }
        });
      });

      const tbody = document.getElementById('parentOverview');
      tbody.innerHTML = '';
      Object.entries(eltern).sort((a, b) => a[0].localeCompare(b[0])).forEach(([name, istPunkte]) => {
        const differenz = istPunkte - globaleSollPunkte;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${name}</td>
          <td>${istPunkte}</td>
          <td>${globaleSollPunkte}</td>
          <td class="${differenz >= 0 ? 'diff-positive' : 'diff-negative'}">${differenz}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // === Einsätze Liste (Elternbereich) ===
    function zeigeEinsaetzeFuerEltern() {
      const einsatzListe = document.getElementById('einsatzListe');
      einsatzListe.innerHTML = '';
      if (globaleDaten.length === 0) {
        einsatzListe.innerHTML = '<p>Keine Einsätze verfügbar.</p>';
        return;
      }

      globaleDaten.forEach(einsatz => {
        const div = document.createElement('div');
        const kategorieClass = katClassName(einsatz.kategorie);
        div.className = `einsatz-box ${kategorieClass}`;
        div.innerHTML = `
          <div class="einsatz-info">
            <div><strong>${einsatz.name || 'Unbenannter Einsatz'}</strong></div>
            <div><strong>Datum:</strong> ${einsatz.datum || 'Nicht angegeben'}</div>
            <div><strong>Uhrzeit:</strong> ${einsatz.uhrzeit || 'Nicht angegeben'}</div>
            <div><strong>Verantwortlich:</strong> ${einsatz.verantwortlich || 'Nicht angegeben'}</div>
            <div><strong>Kategorie:</strong> ${einsatz.kategorie || 'Nicht angegeben'}</div>
            <div><strong>Punkte:</strong> ${einsatz.Punkte || 0}</div>
            <div><strong>Benötigte Helfer:</strong> ${einsatz.helferanzahl || 0}</div>
          </div>
        `;

        if (einsatz.helferanzahl > 0) {
          const helferSection = document.createElement('div');
          helferSection.className = 'helfer-section';
          helferSection.innerHTML = '<h4>Helfer eintragen:</h4>';

          const belegteHelfer = zaehleHelfer(einsatz);
          const statusDiv = document.createElement('div');
          statusDiv.className = 'status-info';
          statusDiv.innerHTML = `Belegt: ${belegteHelfer} von ${einsatz.helferanzahl} Plätzen`;
          helferSection.appendChild(statusDiv);

          for (let i = 0; i < einsatz.helferanzahl; i++) {
            const helferKey = `Helfer${i + 1}`;
            const currentHelfer = einsatz[helferKey] || '';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'helfer-input';
            input.value = currentHelfer;
            input.placeholder = `Helfer ${i + 1}`;
            if (currentHelfer) input.classList.add('filled');

            input.addEventListener('change', function() {
              const newName = this.value.trim();
              setHelfer(einsatz.ID, i, newName);
            });
            input.addEventListener('input', function() {
              if (this.value.trim()) this.classList.add('filled'); else this.classList.remove('filled');
            });

            helferSection.appendChild(input);
          }
          div.appendChild(helferSection);
        }
        einsatzListe.appendChild(div);
      });
    }

    // === Meine Einsätze (ohne Kategorie und ohne Punkte) ===
    function zeigeEigeneEinsaetze() {
      const eigeneEinsaetzeDiv = document.getElementById('eigeneEinsaetze');
      const name = document.getElementById('nameInput').value.trim();
      eigeneEinsaetzeDiv.innerHTML = '';
      if (!name) return;

      let gesamtPunkte = 0;
      const eigeneEinsaetze = [];

      globaleDaten.forEach(einsatz => {
        let istHelfer = false;
        for (let i = 1; i <= 10; i++) {
          if (einsatz[`Helfer${i}`] && einsatz[`Helfer${i}`].trim() === name) { istHelfer = true; break; }
        }
        if (istHelfer) {
          eigeneEinsaetze.push(einsatz);
          gesamtPunkte += Number(einsatz.Punkte || 0);
        }
      });

      if (eigeneEinsaetze.length === 0) {
        eigeneEinsaetzeDiv.innerHTML = `<div class="einsatz-box"><strong>Keine Einsätze für "${name}" gefunden.</strong></div>`;
        return;
      }

      eigeneEinsaetze.forEach(einsatz => {
        const div = document.createElement('div');
        div.className = `einsatz-box ${katClassName(einsatz.kategorie)}`;
        div.innerHTML = `
          <div class="einsatz-info">
            <div><strong>${einsatz.name}</strong></div>
            <div>${einsatz.datum || 'Nicht angegeben'} – ${einsatz.uhrzeit || 'Nicht angegeben'}</div>
            <div>Verantwortlich: ${einsatz.verantwortlich || 'Nicht angegeben'}</div>
          </div>
        `;
        eigeneEinsaetzeDiv.appendChild(div);
      });

      const differenz = gesamtPunkte - globaleSollPunkte;
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'einsatz-box';
      summaryDiv.innerHTML = `
        <strong>Zusammenfassung für "${name}":</strong><br>
        Gesammelte Punkte: ${gesamtPunkte} / ${globaleSollPunkte}<br>
        <span class="${differenz >= 0 ? 'diff-positive' : 'diff-negative'}">Differenz: ${differenz}</span>
      `;
      eigeneEinsaetzeDiv.appendChild(summaryDiv);
    }

    // === Schöne Druckansicht für "Meine Einsätze" ===
    function druckeEigeneEinsaetze() {
      const name = document.getElementById('nameInput').value.trim();
      const wrap = document.getElementById('eigeneEinsaetze');
      const inhalt = wrap.innerHTML;
      if (!inhalt.trim()) { alert('Keine Einsätze zum Drucken vorhanden.'); return; }
      const heute = new Date();
      const datum = heute.toLocaleDateString('de-DE');
      const zeit = heute.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

      const w = window.open('', '', 'height=900,width=800');
      w.document.write(`
        <html>
          <head>
            <meta charset="UTF-8">
            <title>Meine Einsätze</title>
            <style>
              body { font-family: 'Segoe UI', sans-serif; color: #000; margin: 40px }
              header { display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px }
              .brand { font-size: 20px; font-weight: 700 }
              .meta { font-size: 12px; color: #333; text-align: right }
              h2 { margin: 0 0 10px 0 }
              .einsatz-box { border-left: 6px solid #000; background:#fff; padding:12px; margin: 8px 0; border-radius: 6px; box-shadow: 0 1px 0 rgba(0,0,0,0.04) }
              .einsatz-info { display:flex; flex-wrap:wrap; gap:12px; align-items:center }
              .einsatz-info > div { white-space:nowrap }
              footer { margin-top: 24px; font-size: 11px; color: #444 }
              @page { margin: 20mm }
            </style>
          </head>
          <body>
            <header>
              <div class="brand">Waldorfkindergarten Sieben Zwerge – Einsätze</div>
              <div class="meta">
                <div><strong>Name:</strong> ${name || '-'}</div>
                <div>${datum} ${zeit}</div>
              </div>
            </header>
            <main>
              <h2>Meine Einsätze</h2>
              ${inhalt}
            </main>
            <footer>Diese Übersicht wurde automatisch erzeugt</footer>
          </body>
        </html>
      `);
      w.document.close();
      w.focus();
      w.print();
    }

    // === Adminliste rendern (mit Farbstreifen) ===
    function zeigeAdminEinsaetze() {
      const adminEinsaetzeDiv = document.getElementById('adminEinsaetze');
      if (!document.getElementById('adminArea').style.display || document.getElementById('adminArea').style.display === 'none') return;

      adminEinsaetzeDiv.innerHTML = '';
      globaleDaten.forEach(einsatz => {
        const div = document.createElement('div');
        const kategorieClass = katClassName(einsatz.kategorie);
        div.className = `einsatz-box ${kategorieClass}`;
        div.id = `admin-einsatz-${einsatz.ID}`;
        div.innerHTML = `
          <div class="einsatz-info" style="margin-bottom:6px">
            <div><strong>${einsatz.name}</strong></div>
            <div>${einsatz.datum} – ${einsatz.uhrzeit}</div>
            <div>Kategorie: ${einsatz.kategorie}</div>
            <div>Punkte: ${einsatz.Punkte}</div>
            <div>Helfer: ${zaehleHelfer(einsatz)}/${einsatz.helferanzahl}</div>
          </div>
          <div class="admin-actions">
            <button class="btn-primary" onclick="startEditEinsatz('${einsatz.ID}')">Bearbeiten</button>
            <button class="btn-danger"  onclick="deleteEinsatz('${einsatz.ID}')">Löschen</button>
          </div>
        `;
        adminEinsaetzeDiv.appendChild(div);
      });
    }

    // === Modal: Einsatz bearbeiten ===
    function startEditEinsatz(id) {
      const e = globaleDaten.find(x => String(x.ID) === String(id));
      if (!e) return;
      editContext.id = String(id);
      document.getElementById('edit-name').value = e.name || '';
      document.getElementById('edit-datum').value = e.datum || '';
      document.getElementById('edit-uhrzeit').value = e.uhrzeit || '';
      document.getElementById('edit-verantwortlich').value = e.verantwortlich || '';
      document.getElementById('edit-kategorie').value =
        ['Gartenarbeit','Verkaufsaktion','Feste','Kindergartenpflege'].includes(e.kategorie) ? e.kategorie : 'Sonstiges';
      document.getElementById('edit-punkte').value = Number(e.Punkte) || 0;
      document.getElementById('edit-anzahl').value = Number(e.helferanzahl) || 0;
      openEditModal();
    }
    function openEditModal() {
      const m = document.getElementById('editModal');
      m.style.display = 'flex';
      m.setAttribute('aria-hidden', 'false');
    }
    function closeEditModal() {
      const m = document.getElementById('editModal');
      m.style.display = 'none';
      m.setAttribute('aria-hidden', 'true');
      editContext.id = null;
    }
    function saveEdit() {
      if (!editContext.id) return;
      const payload = {
        action: 'updateEinsatz',
        adminPassword: ADMIN_PASS,
        id: editContext.id,
        name: document.getElementById('edit-name').value,
        datum: document.getElementById('edit-datum').value,
        uhrzeit: document.getElementById('edit-uhrzeit').value,
        verantwortlich: document.getElementById('edit-verantwortlich').value,
        kategorie: document.getElementById('edit-kategorie').value,
        Punkte: Number(document.getElementById('edit-punkte').value),
        helferanzahl: Number(document.getElementById('edit-anzahl').value)
      };
      isBusyNetwork = true;
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(r => r.json())
        .then(result => {
          isBusyNetwork = false;
          if (result.success) {
            closeEditModal();
            ladeEinsaetze();
          } else {
            alert('Fehler beim Aktualisieren: ' + (result.message || 'Unbekannter Fehler'));
          }
        })
        .catch(err => { isBusyNetwork = false; alert('Fehler beim Aktualisieren: ' + err.message); });
    }

    // === Helfer setzen ===
    function setHelfer(einsatzId, helferIndex, name) {
      const data = { action: 'setHelfer', id: String(einsatzId), index: helferIndex, name: name };
      isBusyNetwork = true;
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) })
        .then(r => r.json())
        .then(result => { isBusyNetwork = false; if (result.success) ladeEinsaetze(); else alert('Fehler beim Speichern: ' + (result.message || 'Unbekannter Fehler')) })
        .catch(err => { isBusyNetwork = false; alert('Fehler beim Speichern: ' + err.message); });
    }

    // === Admin: neuen Einsatz anlegen ===
    function addEinsatz() {
      const data = {
        action: 'addEinsatz',
        adminPassword: ADMIN_PASS,
        name: document.getElementById('einsatzTitel').value,
        datum: document.getElementById('einsatzDatum').value,
        uhrzeit: document.getElementById('einsatzUhrzeit').value,
        verantwortlich: document.getElementById('einsatzVerantwortlich').value,
        kategorie: document.getElementById('einsatzKategorie').value,
        punkte: Number(document.getElementById('einsatzStunden').value),
        helferanzahl: Number(document.getElementById('einsatzHelferanzahl').value)
      };
      isBusyNetwork = true;
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) })
        .then(r => r.json())
        .then(result => {
          isBusyNetwork = false;
          if (result.success) {
            document.getElementById('einsatzTitel').value = '';
            document.getElementById('einsatzDatum').value = '';
            document.getElementById('einsatzUhrzeit').value = '';
            document.getElementById('einsatzVerantwortlich').value = '';
            document.getElementById('einsatzStunden').value = '';
            document.getElementById('einsatzHelferanzahl').value = '';
            ladeEinsaetze();
          } else alert('Fehler: ' + (result.message || 'Unbekannter Fehler'));
        })
        .catch(err => { isBusyNetwork = false; alert('Fehler beim Erstellen: ' + err.message); });
    }

    // === Admin: löschen ===
    function deleteEinsatz(id) {
      if (!confirm('Einsatz wirklich löschen?')) return;
      isBusyNetwork = true;
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteEinsatz', adminPassword: ADMIN_PASS, id: String(id) }) })
        .then(r => r.json())
        .then(result => { isBusyNetwork = false; if (result.success) ladeEinsaetze(); else alert('Fehler: ' + (result.message || 'Unbekannter Fehler')) })
        .catch(err => { isBusyNetwork = false; alert('Fehler beim Löschen: ' + err.message); });
    }

    // === Helfer zählen ===
    function zaehleHelfer(einsatz) {
      let count = 0;
      for (let i = 1; i <= 10; i++) if (einsatz[`Helfer${i}`] && einsatz[`Helfer${i}`].trim()) count++;
      return count;
    }

    // === Info-Modal und Drucken ===
    function openInfoModal() {
      const m = document.getElementById('infoModal');
      m.style.display = 'flex';
      m.setAttribute('aria-hidden', 'false');
    }
    function closeInfoModal() {
      const m = document.getElementById('infoModal');
      m.style.display = 'none';
      m.setAttribute('aria-hidden', 'true');
    }
    function druckeInfo() {
      const content = document.getElementById('infoContent').innerHTML;
      const w = window.open('', '', 'height=900,width=800');
      w.document.write(`
        <html><head><meta charset="UTF-8"><title>Anleitung</title>
        <style>
          body { font-family: 'Segoe UI', sans-serif; color: #000; margin: 40px }
          h1 { font-size: 20px; margin: 0 0 10px 0 }
          ul { margin: 6px 0 14px 18px }
          li { margin: 4px 0 }
          @page { margin: 18mm }
        </style>
        </head><body>
          <h1>Anleitung für den Bereich „Einsätze“</h1>
          ${content}
        </body></html>
      `);
      w.document.close();
      w.focus();
      w.print();
    }

    // === Boot ===
    document.addEventListener('DOMContentLoaded', () => {
      ladeEinsaetze().then(() => startAutoRefresh());
    });
  </script>
</body>
</html>
