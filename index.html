<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Arbeitseinsätze</title>
  <style>
    body { 
      font-family: 'Segoe UI', sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #f0f4f8; 
      color: #333; 
    }
    .container { 
      max-width: 1200px; 
      margin: 20px auto; 
      padding: 20px; 
      background: white; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    }
    .tabs { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 20px; 
    }
    .nav-tab { 
      background: #ddd; 
      padding: 10px 20px; 
      border-radius: 8px 8px 0 0; 
      cursor: pointer; 
      font-weight: bold; 
      border: none; 
    }
    .nav-tab.active { 
      background: #fff; 
      border-bottom: 2px solid #fff; 
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .kategorien { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      margin-bottom: 20px; 
    }
    .kategorie { 
      padding: 6px 12px; 
      border-radius: 20px; 
      color: white; 
      font-weight: bold; 
    }
    .gruen { background: #4caf50; }
    .orange { background: #ff9800; }
    .lila { background: #9c27b0; }
    .blau { background: #2196f3; }
    .grau { background: #607d8b; }
    .uebersicht { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 20px; 
    }
    .uebersicht th, .uebersicht td { 
      border: 1px solid #ccc; 
      padding: 8px; 
      text-align: center; 
    }
    .uebersicht th { 
      background: #2196f3; 
      color: white; 
    }
    .diff-positive { color: green; font-weight: bold; }
    .diff-negative { color: red; font-weight: bold; }
    input, select, button { 
      width: 100%; 
      margin-bottom: 10px; 
      padding: 10px; 
      font-size: 1rem; 
      box-sizing: border-box; 
      border: 1px solid #ccc; 
      border-radius: 5px; 
    }
    button.btn-primary { 
      background: #2196f3; 
      color: white; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-weight: bold; 
    }
    button.btn-danger { 
      background: #f44336; 
      color: white; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-weight: bold; 
    }
    button:hover { opacity: 0.9; }
    .einsatz-box { 
      border-left: 10px solid #ccc; 
      background: #f9f9f9; 
      padding: 15px; 
      margin-bottom: 15px; 
      border-radius: 8px; 
    }
    .einsatz-gartenarbeit { border-left-color: #4caf50; }
    .einsatz-verkaufsaktion { border-left-color: #ff9800; }
    .einsatz-feste { border-left-color: #9c27b0; }
    .einsatz-kindergartenpflege { border-left-color: #2196f3; }
    .einsatz-sonstiges { border-left-color: #607d8b; }

    /* kompaktere Anzeige der Einsatzdaten */
    .einsatz-info {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .einsatz-info > div {
      white-space: nowrap;
    }

    .helfer-input { 
      display: inline-block; 
      margin: 5px; 
      padding: 6px 10px; 
      border: 2px solid #f44336; 
      border-radius: 5px; 
      min-width: 150px; 
      font-size: 1rem;
      width: auto;
    }
    .helfer-input.filled { 
      background: #e0f7fa; 
      border-color: #4caf50; 
    }
    .helfer-input:disabled { background: #f0f0f0; color: #666; }
    .helfer-section { margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; }
    .helfer-section h4 { margin: 0 0 10px 0; color: #555; }
    .name-input-section { max-width: 420px; margin-bottom: 20px; }
    #nameInput { max-width: 300px; }
    .status-info { font-size: 0.9em; color: #666; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Arbeitseinsätze Waldorfkindergarten Sieben Zwerge</h1>
    
    <div class="tabs">
      <button class="nav-tab active" onclick="showTab('einsatzTab', event)">Einsätze</button>
      <button class="nav-tab" onclick="showTab('adminTab', event)">Admin</button>
    </div>

    <div id="einsatzTab" class="tab-content active">
      <div class="kategorien">
        <span class="kategorie gruen">Gartenarbeit</span>
        <span class="kategorie orange">Verkaufsaktion</span>
        <span class="kategorie lila">Feste</span>
        <span class="kategorie blau">Kindergartenpflege</span>
        <span class="kategorie grau">Sonstiges</span>
      </div>

      <h2>Elternübersicht</h2>
      <table class="uebersicht">
        <thead>
          <tr>
            <th>Name</th>
            <th>IST-Punkte</th>
            <th>SOLL-Punkte</th>
            <th>Differenz</th>
          </tr>
        </thead>
        <tbody id="parentOverview"></tbody>
      </table>

      <div class="name-input-section">
        <input id="nameInput" placeholder="Geben Sie Ihren Namen ein...">
        <button class="btn-primary" onclick="zeigeEigeneEinsaetze()">Meine Einsätze anzeigen</button>
        <button class="btn-primary" onclick="druckeEigeneEinsaetze()">Diese Ansicht drucken</button>
      </div>
      
      <div id="eigeneEinsaetze"></div>

      <h2>Alle verfügbaren Einsätze</h2>
      <div id="einsatzListe"></div>
    </div>

    <div id="adminTab" class="tab-content">
      <h2>Admin-Anmeldung</h2>
      <input id="adminPasswort" type="password" placeholder="Admin Passwort">
      <button class="btn-primary" onclick="loginAdmin()">Anmelden</button>
      
      <div id="adminArea" style="display:none">
        <h2>Neuen Einsatz erstellen</h2>
        <input id="einsatzTitel" placeholder="Einsatzname">
        <input id="einsatzDatum" placeholder="Datum (TT.MM.JJJJ)">
        <input id="einsatzUhrzeit" placeholder="Uhrzeit">
        <input id="einsatzVerantwortlich" placeholder="Verantwortlicher">
        <select id="einsatzKategorie">
          <option value="Gartenarbeit">Gartenarbeit</option>
          <option value="Verkaufsaktion">Verkaufsaktion</option>
          <option value="Feste">Feste</option>
          <option value="Kindergartenpflege">Kindergartenpflege</option>
          <option value="Sonstiges">Sonstiges</option>
        </select>
        <input id="einsatzStunden" placeholder="Punkte" type="number">
        <input id="einsatzHelferanzahl" placeholder="Helferanzahl" type="number">
        <button class="btn-primary" onclick="addEinsatz()">Einsatz erstellen</button>
        
        <h3>Verwaltungsaktionen</h3>
        <button class="btn-danger" onclick="resetAlleHelfer()">Alle Helfereinträge löschen</button>
        
        <h3>Vorhandene Einsätze</h3>
        <div id="adminEinsaetze"></div>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ1P23tsbN5zX-BmqG8eNCg0GhxcTdBhxrogBAZYjheiTZGXPuvOo3PhVEx8SVjCAhqQ/exec';
    const ADMIN_PASS = 'SiebenZwerge';
    let globaleDaten = [];
    let globaleSollPunkte = 10;

    function showTab(id, event) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
    }

    function loginAdmin() {
      const passwortInput = document.getElementById('adminPasswort');
      if (passwortInput.value !== ADMIN_PASS) {
        alert('Falsches Passwort');
        return;
      }
      document.getElementById('adminArea').style.display = 'block';
      ladeEinsaetze();
      alert('Erfolgreich als Admin angemeldet!');
    }

    function ladeEinsaetze() {
      fetch(SCRIPT_URL)
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
          return r.json();
        })
        .then(json => {
          globaleDaten = json.data || [];
          globaleSollPunkte = json.sollPunkte || 10;
          zeigeElternUebersicht();
          zeigeEigeneEinsaetze();
          zeigeEinsaetzeFuerEltern();
          zeigeAdminEinsaetze();
        })
        .catch(err => {
          console.error('Ladefehler:', err);
          alert('Fehler beim Laden der Daten: ' + err.message);
        });
    }

    // Kategorie → CSS-Klasse
    function katClassName(k) {
      if (!k) return 'einsatz-sonstiges';
      const s = k.toString().trim().toLowerCase();
      if (s.startsWith('garten')) return 'einsatz-gartenarbeit';
      if (s.startsWith('verkaufs')) return 'einsatz-verkaufsaktion'; // „Verkaufsaktion“ oder „Verkaufsaktionen“
      if (s.startsWith('fest')) return 'einsatz-feste';
      if (s.includes('kindergarten')) return 'einsatz-kindergartenpflege';
      return 'einsatz-sonstiges';
    }

    function zeigeElternUebersicht() {
      const eltern = {};
      globaleDaten.forEach(einsatz => {
        Object.keys(einsatz).forEach(key => {
          if (key.startsWith('Helfer') && einsatz[key]) {
            const name = einsatz[key].trim();
            if (name) eltern[name] = (eltern[name] || 0) + Number(einsatz.Punkte || 0);
          }
        });
      });

      const tbody = document.getElementById('parentOverview');
      tbody.innerHTML = '';
      Object.entries(eltern)
        .sort((a, b) => a[0].localeCompare(b[0]))
        .forEach(([name, istPunkte]) => {
          const differenz = istPunkte - globaleSollPunkte;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${name}</td>
            <td>${istPunkte}</td>
            <td>${globaleSollPunkte}</td>
            <td class="${differenz >= 0 ? 'diff-positive' : 'diff-negative'}">${differenz}</td>
          `;
          tbody.appendChild(tr);
        });
    }

    function zeigeEinsaetzeFuerEltern() {
      const einsatzListe = document.getElementById('einsatzListe');
      einsatzListe.innerHTML = '';
      if (globaleDaten.length === 0) {
        einsatzListe.innerHTML = '<p>Keine Einsätze verfügbar.</p>';
        return;
      }

      globaleDaten.forEach(einsatz => {
        const div = document.createElement('div');
        const kategorieClass = katClassName(einsatz.kategorie);
        div.className = `einsatz-box ${kategorieClass}`;
        div.innerHTML = `
          <div class="einsatz-info">
            <div><strong>${einsatz.name || 'Unbenannter Einsatz'}</strong></div>
            <div><strong>Datum:</strong> ${einsatz.datum || 'Nicht angegeben'}</div>
            <div><strong>Uhrzeit:</strong> ${einsatz.uhrzeit || 'Nicht angegeben'}</div>
            <div><strong>Verantwortlich:</strong> ${einsatz.verantwortlich || 'Nicht angegeben'}</div>
            <div><strong>Kategorie:</strong> ${einsatz.kategorie || 'Nicht angegeben'}</div>
            <div><strong>Punkte:</strong> ${einsatz.Punkte || 0}</div>
            <div><strong>Benötigte Helfer:</strong> ${einsatz.helferanzahl || 0}</div>
          </div>
        `;

        if (einsatz.helferanzahl > 0) {
          const helferSection = document.createElement('div');
          helferSection.className = 'helfer-section';
          helferSection.innerHTML = '<h4>Helfer eintragen:</h4>';

          const belegteHelfer = zaehleHelfer(einsatz);
          const statusDiv = document.createElement('div');
          statusDiv.className = 'status-info';
          statusDiv.innerHTML = `Belegt: ${belegteHelfer} von ${einsatz.helferanzahl} Plätzen`;
          helferSection.appendChild(statusDiv);

          for (let i = 0; i < einsatz.helferanzahl; i++) {
            const helferKey = `Helfer${i + 1}`;
            const currentHelfer = einsatz[helferKey] || '';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'helfer-input';
            input.value = currentHelfer;
            input.placeholder = `Helfer ${i + 1}`;
            if (currentHelfer) input.classList.add('filled');

            input.addEventListener('change', function() {
              const newName = this.value.trim();
              setHelfer(einsatz.ID, i, newName);
            });
            input.addEventListener('input', function() {
              if (this.value.trim()) this.classList.add('filled');
              else this.classList.remove('filled');
            });

            helferSection.appendChild(input);
          }
          div.appendChild(helferSection);
        }
        einsatzListe.appendChild(div);
      });
    }

    // POST ohne Content-Type Header → kein Preflight
    function setHelfer(einsatzId, helferIndex, name) {
      const data = { action: 'setHelfer', id: String(einsatzId), index: helferIndex, name: name };
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) })
        .then(r => r.json())
        .then(result => {
          if (result.success) ladeEinsaetze();
          else alert('Fehler beim Speichern: ' + (result.message || 'Unbekannter Fehler'));
        })
        .catch(err => alert('Fehler beim Speichern: ' + err.message));
    }

    function zeigeEigeneEinsaetze() {
      const eigeneEinsaetzeDiv = document.getElementById('eigeneEinsaetze');
      const name = document.getElementById('nameInput').value.trim();
      if (!name) { eigeneEinsaetzeDiv.innerHTML = ''; return; }

      let gesamtPunkte = 0;
      const eigeneEinsaetze = [];
      globaleDaten.forEach(einsatz => {
        let istHelfer = false;
        for (let i = 1; i <= 10; i++) {
          if (einsatz[`Helfer${i}`] && einsatz[`Helfer${i}`].trim() === name) { istHelfer = true; break; }
        }
        if (istHelfer) {
          eigeneEinsaetze.push(einsatz);
          gesamtPunkte += Number(einsatz.Punkte || 0);
        }
      });

      eigeneEinsaetzeDiv.innerHTML = '';
      if (eigeneEinsaetze.length === 0) {
        eigeneEinsaetzeDiv.innerHTML = `<div class="einsatz-box"><strong>Keine Einsätze für "${name}" gefunden.</strong></div>`;
        return;
      }

      eigeneEinsaetze.forEach(einsatz => {
        const div = document.createElement('div');
        div.className = `einsatz-box ${katClassName(einsatz.kategorie)}`;
        div.innerHTML = `
          <div class="einsatz-info">
            <div><strong>${einsatz.name}</strong></div>
            <div>${einsatz.datum || 'Nicht angegeben'} – ${einsatz.uhrzeit || 'Nicht angegeben'}</div>
            <div>Verantwortlich: ${einsatz.verantwortlich || 'Nicht angegeben'}</div>
            <div>Kategorie: ${einsatz.kategorie || 'Nicht angegeben'}</div>
          </div>
        `;
        eigeneEinsaetzeDiv.appendChild(div);
      });

      const differenz = gesamtPunkte - globaleSollPunkte;
      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'einsatz-box';
      summaryDiv.innerHTML = `
        <strong>Zusammenfassung für "${name}":</strong><br>
        Gesammelte Punkte: ${gesamtPunkte} / ${globaleSollPunkte}<br>
        <span class="${differenz >= 0 ? 'diff-positive' : 'diff-negative'}">Differenz: ${differenz}</span>
      `;
      eigeneEinsaetzeDiv.appendChild(summaryDiv);
    }

    function druckeEigeneEinsaetze() {
      const wrap = document.getElementById('eigeneEinsaetze');
      const inhalt = wrap.innerHTML;
      if (!inhalt.trim()) {
        alert('Keine Einsätze zum Drucken vorhanden.');
        return;
      }
      const w = window.open('', '', 'height=900,width=800');
      w.document.write(`
        <html>
          <head>
            <title>Meine Einsätze</title>
            <meta charset="UTF-8">
            <style>
              body { font-family: 'Segoe UI', sans-serif; color: #000; }
              h2 { margin-top: 0; }
              .einsatz-box { border-left: 6px solid #000; background:#fff; padding:12px; margin: 8px 0; }
              .einsatz-info { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
              .einsatz-info > div { white-space:nowrap; }
            </style>
          </head>
          <body>
            <h2>Meine Einsätze</h2>
            ${inhalt}
          </body>
        </html>
      `);
      w.document.close();
      w.focus();
      w.print();
      w.close();
    }

    function zeigeAdminEinsaetze() {
      const adminEinsaetzeDiv = document.getElementById('adminEinsaetze');
      if (!document.getElementById('adminArea').style.display || document.getElementById('adminArea').style.display === 'none') return;

      adminEinsaetzeDiv.innerHTML = '';
      globaleDaten.forEach(einsatz => {
        const div = document.createElement('div');
        div.className = 'einsatz-box';
        div.innerHTML = `
          <strong>${einsatz.name}</strong> — ${einsatz.datum} — ${einsatz.uhrzeit}<br>
          <small>Kategorie: ${einsatz.kategorie}, Punkte: ${einsatz.Punkte}, Helfer: ${zaehleHelfer(einsatz)}/${einsatz.helferanzahl}</small><br>
          <button class="btn-danger" onclick="deleteEinsatz('${einsatz.ID}')" style="width:auto; margin-top:5px;">Löschen</button>
        `;
        adminEinsaetzeDiv.appendChild(div);
      });
    }

    function addEinsatz() {
      const data = {
        action: 'addEinsatz',
        adminPassword: ADMIN_PASS,
        name: document.getElementById('einsatzTitel').value,
        datum: document.getElementById('einsatzDatum').value,
        uhrzeit: document.getElementById('einsatzUhrzeit').value,
        verantwortlich: document.getElementById('einsatzVerantwortlich').value,
        kategorie: document.getElementById('einsatzKategorie').value,
        punkte: Number(document.getElementById('einsatzStunden').value),
        helferanzahl: Number(document.getElementById('einsatzHelferanzahl').value)
      };

      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) })
        .then(r => r.json())
        .then(result => {
          if (result.success) {
            alert('Einsatz erfolgreich erstellt!');
            document.getElementById('einsatzTitel').value = '';
            document.getElementById('einsatzDatum').value = '';
            document.getElementById('einsatzUhrzeit').value = '';
            document.getElementById('einsatzVerantwortlich').value = '';
            document.getElementById('einsatzStunden').value = '';
            document.getElementById('einsatzHelferanzahl').value = '';
            ladeEinsaetze();
          } else {
            alert('Fehler: ' + (result.message || 'Unbekannter Fehler'));
          }
        })
        .catch(err => {
          console.error('Fehler beim Erstellen:', err);
          alert('Fehler beim Erstellen des Einsatzes: ' + err.message);
        });
    }

    function resetAlleHelfer() {
      if (!confirm('Wirklich alle Helfereinträge löschen?')) return;
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'removeAllHelfer', adminPassword: ADMIN_PASS }) })
        .then(r => r.json())
        .then(result => {
          if (result.success) { alert('Alle Helfereinträge wurden gelöscht.'); ladeEinsaetze(); }
          else alert('Fehler: ' + (result.message || 'Unbekannter Fehler'));
        })
        .catch(err => {
          console.error('Fehler beim Löschen:', err);
          alert('Fehler beim Löschen der Helfereinträge: ' + err.message);
        });
    }

    function deleteEinsatz(id) {
      if (!confirm('Einsatz wirklich löschen?')) return;
      fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteEinsatz', adminPassword: ADMIN_PASS, id: String(id) }) })
        .then(r => r.json())
        .then(result => {
          if (result.success) { alert('Einsatz erfolgreich gelöscht!'); ladeEinsaetze(); }
          else alert('Fehler: ' + (result.message || 'Unbekannter Fehler'));
        })
        .catch(err => {
          console.error('Fehler beim Löschen:', err);
          alert('Fehler beim Löschen des Einsatzes: ' + err.message);
        });
    }

    function zaehleHelfer(einsatz) {
      let count = 0;
      for (let i = 1; i <= 10; i++) {
        if (einsatz[`Helfer${i}`] && einsatz[`Helfer${i}`].trim()) count++;
      }
      return count;
    }

    document.addEventListener('DOMContentLoaded', ladeEinsaetze);
  </script>
</body>
</html>
