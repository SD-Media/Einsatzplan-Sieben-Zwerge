const SHEET_ID = 'DEINE_SHEET_ID';
const SHEET_NAME = 'Einsaetze';

function formatDateForOutput(d) {
  if (!d) return '';
  if (Object.prototype.toString.call(d) === '[object Date]') {
    return Utilities.formatDate(d, Session.getScriptTimeZone(), 'dd.MM.yyyy');
  }
  const parsed = new Date(d);
  if (!isNaN(parsed)) {
    return Utilities.formatDate(parsed, Session.getScriptTimeZone(), 'dd.MM.yyyy');
  }
  return d;
}

function doGet() {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const result = data.slice(1).filter(r => r.join('').trim() !== '').map(row => {
    const obj = {};
    headers.forEach((h, i) => {
      obj[h] = (h.toLowerCase() === 'datum') ? formatDateForOutput(row[i]) : row[i];
    });
    return obj;
  });
  return ContentService.createTextOutput(JSON.stringify({ success: true, data: result })).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const params = JSON.parse(e.postData.contents);
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data[0];

  if (params.action === 'addEinsatz') {
    sheet.appendRow([Utilities.getUuid(), params.name, formatDateForOutput(params.datum), params.uhrzeit, params.verantwortlich, params.kategorie, params.punkte, params.helferanzahl]);
    return ContentService.createTextOutput(JSON.stringify({ success: true })).setMimeType(ContentService.MimeType.JSON);
  }

  if (params.action === 'updateEinsatz') {
    const idIndex = headers.indexOf('ID');
    const rowIndex = data.findIndex(r => r[idIndex] == params.id);
    if (rowIndex > -1) {
      sheet.getRange(rowIndex+1, 2).setValue(params.name);
      sheet.getRange(rowIndex+1, 3).setValue(params.datum);
      sheet.getRange(rowIndex+1, 4).setValue(params.uhrzeit);
    }
    return ContentService.createTextOutput(JSON.stringify({ success: true })).setMimeType(ContentService.MimeType.JSON);
  }

  if (params.action === 'deleteEinsatz') {
    const idIndex = headers.indexOf('ID');
    const rowIndex = data.findIndex(r => r[idIndex] == params.id);
    if (rowIndex > -1) sheet.deleteRow(rowIndex+1);
    return ContentService.createTextOutput(JSON.stringify({ success: true })).setMimeType(ContentService.MimeType.JSON);
  }

  return ContentService.createTextOutput(JSON.stringify({ success: false })).setMimeType(ContentService.MimeType.JSON);
}
